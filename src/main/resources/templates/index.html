<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Estudiantes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="d-flex justify-content-end mb-3">
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-danger">Cerrar Sesión</button>
        </form>
    </div>
    <h1>Estudiantes</h1>
    <div th:if="${username}" class="alert alert-info mb-3">
        Hola <span th:text="${username}"></span>!
        <span th:if="${isAdmin}">(Administrador)</span>
        <span th:if="${isSecretary}">(Secretaria)</span>
    </div>
    <div th:if="${mensaje}" class="alert alert-warning" th:text="${mensaje}"></div>

    <form th:action="@{/estudiantes/buscar}" method="get" class="row g-2 mb-3">
        <div class="col-auto"><input name="cedula" class="form-control" placeholder="Buscar cédula" required></div>
        <div class="col-auto">
            <button class="btn btn-primary">Buscar</button>
            <a href="/" class="btn btn-secondary">Ver todos</a>
        </div>
    </form>

    <button class="btn btn-success mb-3" id="btnNuevo" data-bs-toggle="modal" data-bs-target="#modalEstudiante">Nuevo
    </button>

    <table class="table table-hover">
        <thead>
        <tr>
            <th>Cédula</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Dirección</th>
            <th>Teléfono</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="e : ${estudiantes}">
            <td th:text="${e.cedula}"></td>
            <td th:text="${e.nombre}"></td>
            <td th:text="${e.apellido}"></td>
            <td th:text="${e.direccion}"></td>
            <td th:text="${e.telefono}"></td>
            <td>
                <button class="btn btn-warning btn-sm editar-btn" data-bs-toggle="modal"
                        data-bs-target="#modalEstudiante"
                        th:attr="data-cedula=${e.cedula}, data-nombre=${e.nombre}, data-apellido=${e.apellido},
                                 data-direccion=${e.direccion}, data-telefono=${e.telefono}">Editar
                </button>
                <a th:href="@{/estudiantes/eliminar/{cedula}(cedula=${e.cedula})}"
                   class="btn btn-danger btn-sm btn-eliminar">Eliminar</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Modal Estudiante -->
<div class="modal fade" id="modalEstudiante" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEstudiante" method="post" action="/estudiantes">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="modal-header">
                    <h5 class="modal-title">Estudiante</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input name="cedula" class="form-control mb-2" placeholder="Cédula" required>
                    <input name="nombre" class="form-control mb-2" placeholder="Nombre" required>
                    <input name="apellido" class="form-control mb-2" placeholder="Apellido" required>
                    <input name="direccion" class="form-control mb-2" placeholder="Dirección">
                    <input name="telefono" class="form-control mb-2" placeholder="Teléfono">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("formEstudiante");

        document.querySelectorAll(".editar-btn").forEach(btn => {
            btn.onclick = () => {
                form.action = "/estudiantes/editar/" + btn.dataset.cedula;
                form.cedula.value = btn.dataset.cedula;
                form.cedula.readOnly = true;
                form.nombre.value = btn.dataset.nombre;
                form.apellido.value = btn.dataset.apellido;
                form.direccion.value = btn.dataset.direccion;
                form.telefono.value = btn.dataset.telefono;
            };
        });

        document.getElementById("btnNuevo").onclick = () => {
            form.action = "/estudiantes";
            form.reset();
            form.cedula.readOnly = false;
        };
    });
    document.addEventListener("DOMContentLoaded", () => {
        // Confirmación para eliminar
        document.querySelectorAll(".btn-eliminar").forEach(btn => {
            btn.addEventListener("click", function (e) {
                const confirmed = confirm("¿Estás seguro de que deseas eliminar este estudiante?");
                if (!confirmed) {
                    e.preventDefault(); // Cancela la navegación si el usuario no confirma
                }
            });
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
